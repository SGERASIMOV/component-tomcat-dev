### Tomcat Application Server
application:
  configuration:
    configuration.app-port: 8080
    configuration.java-opts: "-Duser.timezone=UTC"
    configuration.recipe-url: "https://s3.amazonaws.com/qubell-starter-kit-artifacts/qubell-bazaar/component-tomcat-dev-cookbooks-stable-a3a40b1.tar.gz"
    compute-config.hardwareId: "c3.large"
    compute-config.imageId:    "ami-246ed34c"
    compute-config.login:      "ec2-user"
    compute-config.locationId: "us-east-1"
  interfaces:
    configuration:
      "*": "bind(installer#input.*)"
      recipe-url:  "bind(installer#input.recipe-url, deployer#input.recipe-url)"
      app-port:  "bind(installer#input.app-port, deployer#input.app-port)"
    compute-config:
      hardwareId: "bind(compute#configuration.hardwareId)"
      imageId:    "bind(compute#configuration.imageId)"
      login:      "bind(compute#configuration.login)"
      locationId: "bind(compute#configuration.locationId)"
    compute:
      "*": "bind(compute#compute.*)"
    tomcat:
      manage-service: "bind(deployer#actions.manage-service)"
      updateSource: "bind(deployer#actions.updateSource)"
      app-host: "bind(installer#result.app-host)"
      app-port: "bind(installer#result.app-port)"
      app-uri: "bind(installer#result.app-uri)"
    source:
      lib-uri:       "bind(deployer#source.lib-uri)"
      context-nodes: "bind(deployer#source.context-nodes)"
      context-attrs: "bind(deployer#source.context-attrs)"
      uri:           "bind(deployer#source.uri)"
      path:          "bind(deployer#source.path)"
      java-opts:     "bind(deployer#source.java-opts)"

  bindings:
   - [installer, compute]
   - [installer, deployer]
   - [deployer, compute]

  components:
    installer:
      type: workflow.Instance
      interfaces:
        input:
          app-port:     { type: configuration(int),          name: Tomcat listen port }
          java-opts:    { type: configuration(string),       name: JAVA_OPTS          }
          recipe-url:   { type: configuration(string),       name: Cookbooks url      }
        compute:
          networks:   consume-signal(map<string, map<string, string>>)
          exec:       send-command(string command, int timeout => string stdOut, string stdErr => string stdOut, string stdErr, int exitCode)
          put-file:   send-command(string filename, bytes payload)
          get-file:   send-command(string filename => bytes payload)
        result:
          app-host: publish-signal(string)
          app-port: publish-signal(int)
          app-uri: publish-signal(string)
      required: [ compute ]
      configuration:
        configuration.triggers:
          input.app-port:       update
          input.java-opts:      update
          input.recipe-url:     update
          compute.networks:     update
        configuration.propagateStatus:  
          - update
        configuration.workflows:
          update: &update
            steps:
              - get-signals:
                  action: getSignals
                  output:
                    signals: result
              - install-tomcat:
                  action: "chefsolo"
                  precedingPhases: [ get-signals ]
                  parameters:
                    retryCount: 3
                    roles: [ compute ]
                    runList: ["recipe[cookbook-qubell-tomcat]"]
                    recipeUrl: "{$.recipe-url}"
                    jattrs:
                      tomcat:
                        port: "{$.app-port}"
                        java_options: "{$.java-opts}"
            return:
              app-host: { value: "{$.signals.compute.networks.public.ip}" }
              app-port: { value: "{$.app-port}" }
              app-uri:  { value: "{$.signals.compute.networks.public.ip}:{$.app-port}" }

          launch: *update

    deployer:
      type: workflow.Instance
      interfaces:
        input:
          recipe-url:   { type: configuration(string),       name: Cookbooks url      }
          app-port:     { type: configuration(int),          name: Tomcat listen port }
        tomcat:
          app-host: consume-signal(string)
        compute:
          networks:   consume-signal(map<string, map<string, string>>)
          exec:       send-command(string command, int timeout => string stdOut, string stdErr => string stdOut, string stdErr, int exitCode)
          put-file:   send-command(string filename, bytes payload)
          get-file:   send-command(string filename => bytes payload)
        source:
          lib-uri:       consume-signal(list<string>)
          context-nodes: consume-signal(object)
          context-attrs: consume-signal(object)
          uri:           consume-signal(list<string>)
          path:          consume-signal(list<string>)
          java-opts:     consume-signal(string)
        actions:
          update: receive-command()
          updateSource: receive-command(string uri, string path, object context-attrs, object context-nodes, string java-options, list<string> lib-uri)
          manage-service:
             type: receive-command(string service-action)
             name: Manage service
      required: [ tomcat, source, compute ]
      configuration:
        configuration.triggers:
          source.*:             update
        configuration.propagateStatus:  
          - update
          - updateSource
        configuration.workflows:
          update: &update
            steps:
              - get-signals:
                  action: getSignals
                  parameters:
                    multi: true
                  output:
                    signals: result
              - deploy:
                  action: updateSource
                  precedingPhases: [ get-signals ]
                  parameters:
                    java-options:  "{$.signals.source..java-opts[0]}"
                    lib-uri:       "{$.signals.source..lib-uri}"
                    context-nodes: "{$.signals.source..context-nodes}"
                    context-attrs: "{$.signals.source..context-attrs[0]}"
                    uri:           "{$.signals.source..uri}"
                    path:          "{$.signals.source..path}"
          
          launch: *update

          updateSource:
            parameters:
              - java-options:
                  description: Java opts
              - lib-uri:
                  description: Lib url
              - uri:
                  description: War url
              - path:
                  description: War path
              - context-attrs:
                  description: Context attrs
              - context-nodes:
                  description: Context nodes
            steps:
              - get-signals:
                  action: getSignals
                  parameters:
                    multi: true
                  output:
                    signals: result
              - reconfigure-tomcat:
                  action: reconfigure
                  phase: reconfigure-tomcat
                  precedingPhases: [ get-signals ]
                  parameters:
                    java-options: "{$.java-options}"
                  output:
                    app-uri: app-uri
              - deploy-libs:
                  action: deploy-libs
                  phase: deploy-libs
                  precedingPhases: [ reconfigure-tomcat ]
                  parameters:
                    recipe-url: "{$.recipe-url}"
                    lib-uri: "{$.lib-uri}"
              - deploy-application:
                  action: deploy-war
                  phase: deploy-scm-application
                  precedingPhases: [ deploy-libs ]
                  parameters:
                    recipe-url: "{$.recipe-url}"
                    uri: "{$.uri}"
                    path: "{$.path}"
                    context-attrs: "{$.context-attrs}"
                    context-nodes: "{$.context-nodes}"
                    


          deploy-libs: ###  Additional Tomcat libraries installation workflow
            parameters:
              - recipe-url:
                  description: Cookbooks Url
              - lib-uri:
                  description: Lib Uri
            steps:
              - get-signals:
                  action: getSignals
                  output:
                    signals: result
              - deploy-libs:
                  action: "chefrun"
                  phase: deploy-libs
                  precedingPhases: [ get-signals ]
                  parameters:
                    isSolo: true
                    roles: [ compute ]
                    runList: [ "recipe[cookbook-qubell-tomcat::deploy_libs]" ]
                    recipeUrl: "{$.recipe-url}" 
                    jattrs:
                      cookbook-qubell-tomcat:
                        lib_uri: "{$.lib-uri}"

          deploy-war: ### Additional workflow for deploy artifacts(local/web) in your Tomcat webapps
            parameters:
              - recipe-url:
                  description: Cookbooks Url
              - uri:
                  description: War url
              - path:
                  description: War path
              - context-attrs:
                  description: Context attrs
              - context-nodes:
                  description: Context nodes
            steps:
              - get-signals:
                  action: getSignals
                  output:
                    signals: result
              - deploy-war:
                  action: "chefrun"
                  phase: deploy-war
                  precedingPhases: [ get-signals ]
                  parameters:
                    isSolo: true
                    roles: [ compute ]
                    runList: [ "recipe[cookbook-qubell-tomcat::deploy_war]" ]
                    recipeUrl: "{$.recipe-url}"
                    jattrs:
                      cookbook-qubell-tomcat:
                        war:
                          uri:  "{$.uri}"
                          path: "{$.path}"
                        context:
                          context_attrs: "{$.context-attrs}"
                          context_nodes: "{$.context-nodes}"
          reconfigure: ### Additional workflow for reconfiguring Tomcat in case changing app-port and java-opts
            parameters:
              - java-options:
                  description: Java opts
            steps:
              - get-signals:
                  action: getSignals
                  output:
                    signals: result
              - reconfigure-tomcat:
                  action: "chefrun"
                  phase: reconfigure-tomcat
                  precedingPhases: [ get-signals ]
                  parameters:
                    isSolo: true
                    roles: [compute]
                    runList: ["recipe[cookbook-qubell-tomcat]"]
                    recipeUrl: "{$.recipe-url}"
                    jattrs:
                      tomcat:
                        port: "{$.app-port}"
                        java_options: "{$.java-options}"
            return:
              app-uri: { value: "{$.signals.compute.networks.public.ip}:{$.app-port}" }

          manage-service: ### ### Additional workflow for start/stop/restart service
            steps:
              - get-signals:
                  action: getSignals
                  output:
                    signals: result
              - run-service-action:
                  action: "chefrun"
                  phase: "run-service-action"
                  precedingPhases: [ get-signals ]
                  parameters:
                    isSolo: true
                    roles: [compute]
                    runList: ["recipe[cookbook-qubell-tomcat::manage]"]
                    recipeUrl: "{$.recipe-url}"
                    jattrs:
                      base:
                        manage:
                          services: ["tomcat6"]
                          action: "{$.service-action}"



    compute:
      type: compute.Instance
  
